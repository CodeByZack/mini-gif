!function(t,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r():"function"==typeof define&&define.amd?define(r):(t="undefined"!=typeof globalThis?globalThis:t||self).minigif=r()}(this,(function(){"use strict";var t=function(){var t,r,e,n,i,o={},a=256,f=499,u=491,c=487,l=503,s=3*l,h=a-1,w=4,v=100,y=16,d=1<<y,g=10,p=10,B=d>>p,b=d<<g-p,m=a>>3,k=6,x=1<<k,F=m*x,A=30,I=10,E=1<<I,_=8,U=1<<_,T=I+_,G=1<<T,C=[],z=[],D=[],S=[],R=o.NeuQuant=function(t,o,f){var u,c;for(r=t,e=o,n=f,i=new Array(a),u=0;u<a;u++)i[u]=new Array(4),(c=i[u])[0]=c[1]=c[2]=(u<<w+8)/a,D[u]=d/a,z[u]=0},j=function(){for(var t=[],r=new Array(a),e=0;e<a;e++)r[i[e][3]]=e;for(var n=0,o=0;o<a;o++){var f=r[o];t[n++]=i[f][0],t[n++]=i[f][1],t[n++]=i[f][2]}return t},M=function(){var t,r,e,n,o,f,u,c;for(u=0,c=0,t=0;t<a;t++){for(e=t,n=(o=i[t])[1],r=t+1;r<a;r++)(f=i[r])[1]<n&&(e=r,n=f[1]);if(f=i[e],t!=e&&(r=f[0],f[0]=o[0],o[0]=r,r=f[1],f[1]=o[1],o[1]=r,r=f[2],f[2]=o[2],o[2]=r,r=f[3],f[3]=o[3],o[3]=r),n!=u){for(C[u]=c+t>>1,r=u+1;r<n;r++)C[r]=t;u=n,c=t}}for(C[u]=c+h>>1,r=u+1;r<256;r++)C[r]=h},P=function(){var i,o,a,h,y,d,g,p,B,b,m,x,I,_;for(e<s&&(n=1),t=30+(n-1)/3,x=r,I=0,_=e,b=(m=e/(3*n))/v|0,p=E,(g=(d=F)>>k)<=1&&(g=0),i=0;i<g;i++)S[i]=p*((g*g-i*i)*U/(g*g));for(B=e<s?3:e%f!=0?3*f:e%u!=0?3*u:e%c!=0?3*c:3*l,i=0;i<m;)if(a=(255&x[I+0])<<w,h=(255&x[I+1])<<w,y=(255&x[I+2])<<w,o=L(a,h,y),Q(p,o,a,h,y),0!==g&&N(g,o,a,h,y),(I+=B)>=_&&(I-=e),0===b&&(b=1),++i%b==0)for(p-=p/t,(g=(d-=d/A)>>k)<=1&&(g=0),o=0;o<g;o++)S[o]=p*((g*g-o*o)*U/(g*g))},W=(o.map=function(t,r,e){var n,o,f,u,c,l,s;for(c=1e3,s=-1,o=(n=C[r])-1;n<a||o>=0;)n<a&&((f=(l=i[n])[1]-r)>=c?n=a:(n++,f<0&&(f=-f),(u=l[0]-t)<0&&(u=-u),(f+=u)<c&&((u=l[2]-e)<0&&(u=-u),(f+=u)<c&&(c=f,s=l[3])))),o>=0&&((f=r-(l=i[o])[1])>=c?o=-1:(o--,f<0&&(f=-f),(u=l[0]-t)<0&&(u=-u),(f+=u)<c&&((u=l[2]-e)<0&&(u=-u),(f+=u)<c&&(c=f,s=l[3]))));return s},o.process=function(){return P(),W(),M(),j()},function(){var t;for(t=0;t<a;t++)i[t][0]>>=w,i[t][1]>>=w,i[t][2]>>=w,i[t][3]=t}),N=function(t,r,e,n,o){var f,u,c,l,s,h,w;for((c=r-t)<-1&&(c=-1),(l=r+t)>a&&(l=a),f=r+1,u=r-1,h=1;f<l||u>c;){if(s=S[h++],f<l){w=i[f++];try{w[0]-=s*(w[0]-e)/G,w[1]-=s*(w[1]-n)/G,w[2]-=s*(w[2]-o)/G}catch(t){}}if(u>c){w=i[u--];try{w[0]-=s*(w[0]-e)/G,w[1]-=s*(w[1]-n)/G,w[2]-=s*(w[2]-o)/G}catch(t){}}}},Q=function(t,r,e,n,o){var a=i[r];a[0]-=t*(a[0]-e)/E,a[1]-=t*(a[1]-n)/E,a[2]-=t*(a[2]-o)/E},L=function(t,r,e){var n,o,f,u,c,l,s,h,v,d;for(v=h=~(1<<31),s=l=-1,n=0;n<a;n++)(o=(d=i[n])[0]-t)<0&&(o=-o),(f=d[1]-r)<0&&(f=-f),o+=f,(f=d[2]-e)<0&&(f=-f),(o+=f)<h&&(h=o,l=n),(u=o-(z[n]>>y-w))<v&&(v=u,s=n),c=D[n]>>p,D[n]-=c,z[n]+=c<<g;return D[l]+=B,z[l]-=b,s};return R.apply(this,arguments),o},r=function(){var t,r,e,n,i,o,a,f,u,c,l,s,h={},w=-1,v=12,y=5003,d=v,g=1<<v,p=[],B=[],b=y,m=0,k=!1,x=0,F=0,A=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535],I=[],E=h.LZWEncoder=function(i,o,a,f){t=i,r=o,e=a,n=Math.max(2,f)},_=function(t,r){I[s++]=t,s>=254&&C(r)},U=function(t){T(b),m=c+2,k=!0,S(c,t)},T=function(t){for(var r=0;r<t;++r)p[r]=-1},G=h.compress=function(t,r){var e,n,i,o,h,v,y;for(k=!1,f=z(a=u=t),l=(c=1<<t-1)+1,m=c+2,s=0,o=D(),y=0,e=b;e<65536;e*=2)++y;y=8-y,T(v=b),S(c,r);t:for(;(i=D())!=w;)if(e=(i<<d)+o,p[n=i<<y^o]!=e){if(p[n]>=0){h=v-n,0===n&&(h=1);do{if((n-=h)<0&&(n+=v),p[n]==e){o=B[n];continue t}}while(p[n]>=0)}S(o,r),o=i,m<g?(B[n]=m++,p[n]=e):U(r)}else o=B[n];S(o,r),S(l,r)},C=(h.encode=function(e){e.writeByte(n),i=t*r,o=0,G(n+1,e),e.writeByte(0)},function(t){s>0&&(t.writeByte(s),t.writeBytes(I,0,s),s=0)}),z=function(t){return(1<<t)-1},D=function(){return 0===i?w:(--i,255&e[o++])},S=function(t,r){for(x&=A[F],F>0?x|=t<<F:x=t,F+=a;F>=8;)_(255&x,r),x>>=8,F-=8;if((m>f||k)&&(k?(f=z(a=u),k=!1):(++a,f=a==d?g:z(a))),t==l){for(;F>0;)_(255&x,r),x>>=8,F-=8;C(r)}};return E.apply(this,arguments),h};function e(t,r,e,n){for(var i=t[r++],o=1<<i,a=o+1,f=a+1,u=i+1,c=(1<<u)-1,l=0,s=0,h=0,w=t[r++],v=new Int32Array(4096),y=null;;){for(;l<16&&0!==w;)s|=t[r++]<<l,l+=8,1===w?w=t[r++]:--w;if(l<u)break;var d=s&c;if(s>>=u,l-=u,d!==o){if(d===a)break;for(var g=d<f?d:y,p=0,B=g;B>o;)B=v[B]>>8,++p;var b=B;if(h+p+(g!==d?1:0)>n)return void console.log("Warning, gif stream longer than expected.");e[h++]=b;var m=h+=p;for(g!==d&&(e[h++]=b),B=g;p--;)B=v[B],e[--m]=255&B,B>>=8;null!==y&&f<4096&&(v[f++]=y<<8|b,f>=c+1&&u<12&&(++u,c=c<<1|1)),y=d}else f=a+1,c=(1<<(u=i+1))-1,y=null}return h!==n&&console.log("Warning, gif stream shorter than expected."),e}return{GIFEncoder:function(){for(var e=0,n={};e<256;e++)n[e]=String.fromCharCode(e);function i(){this.bin=[]}i.prototype.getData=function(){for(var t="",r=this.bin.length,e=0;e<r;e++)t+=n[this.bin[e]];return t},i.prototype.getUnit8Array=function(){for(var t=new Uint8Array(this.bin.length),r=this.bin.length,e=0;e<r;e++)t[e]=this.bin[e];return t},i.prototype.writeByte=function(t){this.bin.push(t)},i.prototype.writeUTFBytes=function(t){for(var r=t.length,e=0;e<r;e++)this.writeByte(t.charCodeAt(e))},i.prototype.writeBytes=function(t,r,e){for(var n=e||t.length,i=r||0;i<n;i++)this.writeByte(t[i])};var o,a,f,u,c,l,s,h,w,v={},y=null,d=-1,g=0,p=!1,B=[],b=7,m=-1,k=!0,x=!1,F=10,A="Generated by jsgif (https://github.com/antimatter15/jsgif/)",I=(v.setDelay=function(t){g=Math.round(t/10)},v.setDispose=function(t){t>=0&&(m=t)},v.setRepeat=function(t){t>=0&&(d=t)},v.setTransparent=function(t){y=t},v.setComment=function(t){A=t},v.addFrame=function(t,r){if(null===t||!p||null===u)throw new Error("Please call start method before calling addFrame");var e=!0;try{r?c=t:(c=t.getImageData(0,0,t.canvas.width,t.canvas.height).data,x||E(t.canvas.width,t.canvas.height)),T(),_(),k&&(D(),R(),d>=0&&S()),G(),""!==A&&C(),z(),k||R(),M(),k=!1}catch(t){e=!1}return e},v.finish=function(){if(!p)return!1;var t=!0;p=!1;try{u.writeByte(59)}catch(r){t=!1}return t},function(){f=0,c=null,l=null,s=null,w=null,k=!0}),E=(v.setFrameRate=function(t){15!=t&&(g=Math.round(100/t))},v.setQuality=function(t){t<1&&(t=1),F=t},v.setSize=function(t,r){p&&!k||((o=t)<1&&(o=320),(a=r)<1&&(a=240),x=!0)}),_=(v.start=function(){I();var t=!0;u=new i;try{u.writeUTFBytes("GIF89a")}catch(r){t=!1}return p=t},v.cont=function(){I();return u=new i,p=!0},function(){var r=l.length,e=r/3;s=[];var n=new t(l,r,F);w=n.process();for(var i=0,o=0;o<e;o++){var a=n.map(255&l[i++],255&l[i++],255&l[i++]);B[a]=!0,s[o]=a}l=null,h=8,b=7,null!==y&&(f=U(y))}),U=function(t){if(null===w)return-1;for(var r=(16711680&t)>>16,e=(65280&t)>>8,n=255&t,i=0,o=16777216,a=w.length,f=0;f<a;){var u=r-(255&w[f++]),c=e-(255&w[f++]),l=n-(255&w[f]),s=u*u+c*c+l*l,h=f/3;B[h]&&s<o&&(o=s,i=h),f++}return i},T=function(){var t=o,r=a;l=[];for(var e=c,n=0,i=0;i<r;i++)for(var f=0;f<t;f++){var u=i*t*4+4*f;l[n++]=e[u],l[n++]=e[u+1],l[n++]=e[u+2]}},G=function(){var t,r;u.writeByte(33),u.writeByte(249),u.writeByte(4),null===y?(t=0,r=0):(t=1,r=2),m>=0&&(r=7&m),r<<=2,u.writeByte(0|r|t),j(g),u.writeByte(f),u.writeByte(0)},C=function(){u.writeByte(33),u.writeByte(254),u.writeByte(A.length),u.writeUTFBytes(A),u.writeByte(0)},z=function(){u.writeByte(44),j(0),j(0),j(o),j(a),k?u.writeByte(0):u.writeByte(128|b)},D=function(){j(o),j(a),u.writeByte(240|b),u.writeByte(0),u.writeByte(0)},S=function(){u.writeByte(33),u.writeByte(255),u.writeByte(11),u.writeUTFBytes("NETSCAPE2.0"),u.writeByte(3),u.writeByte(1),j(d),u.writeByte(0)},R=function(){u.writeBytes(w);for(var t=768-w.length,r=0;r<t;r++)u.writeByte(0)},j=function(t){u.writeByte(255&t),u.writeByte(t>>8&255)},M=function(){new r(o,a,s,h).encode(u)};v.stream=function(){return u},v.setProperties=function(t,r){p=t,k=r};return v},GIFDecoder:function(t){var r=0;if(71!==t[r++]||73!==t[r++]||70!==t[r++]||56!==t[r++]||56!=(t[r++]+1&253)||97!==t[r++])throw new Error("Invalid GIF 87a/89a header.");var n=t[r++]|t[r++]<<8,i=t[r++]|t[r++]<<8,o=t[r++],a=o>>7,f=1<<(7&o)+1;t[r++],t[r++];var u=null,c=null;a&&(u=r,c=f,r+=3*f);var l=!0,s=[],h=0,w=null,v=0,y=null;for(this.width=n,this.height=i;l&&r<t.length;)switch(t[r++]){case 33:switch(t[r++]){case 255:if(11!==t[r]||78==t[r+1]&&69==t[r+2]&&84==t[r+3]&&83==t[r+4]&&67==t[r+5]&&65==t[r+6]&&80==t[r+7]&&69==t[r+8]&&50==t[r+9]&&46==t[r+10]&&48==t[r+11]&&3==t[r+12]&&1==t[r+13]&&0==t[r+16])r+=14,y=t[r++]|t[r++]<<8,r++;else for(r+=12;;){if(!((_=t[r++])>=0))throw Error("Invalid block size");if(0===_)break;r+=_}break;case 249:if(4!==t[r++]||0!==t[r+4])throw new Error("Invalid graphics extension block.");var d=t[r++];h=t[r++]|t[r++]<<8,w=t[r++],0==(1&d)&&(w=null),v=d>>2&7,r++;break;case 1:case 254:for(;;){if(!((_=t[r++])>=0))throw Error("Invalid block size");if(0===_)break;r+=_}break;default:throw new Error("Unknown graphic control label: 0x"+t[r-1].toString(16))}break;case 44:var g=t[r++]|t[r++]<<8,p=t[r++]|t[r++]<<8,B=t[r++]|t[r++]<<8,b=t[r++]|t[r++]<<8,m=t[r++],k=m>>6&1,x=1<<(7&m)+1,F=u,A=c,I=!1;if(m>>7){I=!0;F=r,A=x,r+=3*x}var E=r;for(r++;;){var _;if(!((_=t[r++])>=0))throw Error("Invalid block size");if(0===_)break;r+=_}s.push({x:g,y:p,width:B,height:b,has_local_palette:I,palette_offset:F,palette_size:A,data_offset:E,data_length:r-E,transparent_index:w,interlaced:!!k,delay:h,disposal:v});break;case 59:l=!1;break;default:throw new Error("Unknown gif block: 0x"+t[r-1].toString(16))}this.numFrames=function(){return s.length},this.loopCount=function(){return y},this.frameInfo=function(t){if(t<0||t>=s.length)throw new Error("Frame index out of range.");return s[t]},this.decodeAndBlitFrameBGRA=function(r,i){var o=this.frameInfo(r),a=o.width*o.height,f=new Uint8Array(a);e(t,o.data_offset,f,a);var u=o.palette_offset,c=o.transparent_index;null===c&&(c=256);var l=o.width,s=n-l,h=l,w=4*(o.y*n+o.x),v=4*((o.y+o.height)*n+o.x),y=w,d=4*s;!0===o.interlaced&&(d+=4*n*7);for(var g=8,p=0,B=f.length;p<B;++p){var b=f[p];if(0===h&&(h=l,(y+=d)>=v&&(d=4*s+4*n*(g-1),y=w+(l+s)*(g<<1),g>>=1)),b===c)y+=4;else{var m=t[u+3*b],k=t[u+3*b+1],x=t[u+3*b+2];i[y++]=x,i[y++]=k,i[y++]=m,i[y++]=255}--h}},this.decodeAndBlitFrameRGBA=function(r,i){var o=this.frameInfo(r),a=o.width*o.height,f=new Uint8Array(a);e(t,o.data_offset,f,a);var u=o.palette_offset,c=o.transparent_index;null===c&&(c=256);var l=o.width,s=n-l,h=l,w=4*(o.y*n+o.x),v=4*((o.y+o.height)*n+o.x),y=w,d=4*s;!0===o.interlaced&&(d+=4*n*7);for(var g=8,p=0,B=f.length;p<B;++p){var b=f[p];if(0===h&&(h=l,(y+=d)>=v&&(d=4*s+4*n*(g-1),y=w+(l+s)*(g<<1),g>>=1)),b===c)y+=4;else{var m=t[u+3*b],k=t[u+3*b+1],x=t[u+3*b+2];i[y++]=m,i[y++]=k,i[y++]=x,i[y++]=255}--h}}}}}));
